{{/*
  SCHEDULE GRID
  - Supports `type: "talk"` for 3-column track items.
  - Supports `type: "break"` for full-width items like coffee breaks.
*/}}

{{ $page := . }}

{{/* 1. Collect all schedule items and filter */}}
{{ $allEvents := where site.RegularPages "Type" "in" (slice "talk" "break") }}
{{ $allEvents = where $allEvents "Draft" "ne" true }}

{{ $scheduleYearParam := .Params.schedule_year }}
{{ if $scheduleYearParam }}
  {{ $yearInt := int (strings.TrimPrefix "year_" $scheduleYearParam) }}
  {{ $allEvents = where $allEvents "Date.Year" $yearInt }}
{{ end }}

{{/* 3. Define track display order and layout */}}
{{ $displayTracks := slice "Software & Hardware (So-Ha)" "Data Centers / Infrastructure / Management (DIM)" "Community Track" }}
{{ $colWidth := 3 }}
{{ if eq (len $displayTracks) 2 }}{{ $colWidth = 5 }}{{ else if eq (len $displayTracks) 1 }}{{ $colWidth = 10 }}{{ end }}

<section class="section-schedule section">
  <div class="container">
    <div class="row section-heading">
      <div class="col-lg">
        <div class="heading">
          <span class="stroke-text">Schedule</span>
          <div class="pl-90">
            <h2 class="mt-2">{{ .Title }}</h2>
            <p>Three-track program. Click a talk for details.</p>
          </div>
        </div>
      </div>
    </div>

    {{/* 4. Group events by day */}}
    {{ range $day := sort ($allEvents.GroupByDate "2006-01-02") "Key" }}
      {{ $dayEvents := $day.Pages }}
      {{ $dayTalks := where $dayEvents "Type" "talk" }}
      {{ $dayBreaks := where $dayEvents "Type" "break" }}

      {{ $times := slice }}
      {{ range $dayEvents }}{{ $times = $times | append (.Date.Format "15:04") }}{{ end }}
      {{ $times = $times | uniq | sort }}

      <div class="row mt-5"><div class="col-12"><h3 class="mb-4">{{ (time $day.Key).Format "Monday, 02 January 2006" }}</h3></div></div>

      <div class="row align-items-end mb-4 d-none d-lg-flex">
        <div class="col-lg-2"><div class="text-uppercase small font-weight-bold text-muted">Time</div></div>
        {{ range $track := $displayTracks }}<div class="col-lg-{{ $colWidth }}"><h4 class="text-uppercase small font-weight-bold">{{ . }}</h4></div>{{ end }}
      </div>

      {{/* 5. Render rows for each time slot */}}
      {{ range $t := $times }}
        {{ $breakItem := slice }}
        {{ range $dayBreaks }}{{ if eq (.Date.Format "15:04") $t }}{{ $breakItem = $breakItem | append . }}{{ end }}{{ end }}

        <div class="row align-items-stretch mb-3 py-3 border-bottom">
          <div class="col-12 col-lg-2 mb-2 mb-lg-0"><h5 class="time text-color mb-0">{{ $t }}</h5></div>
          
          {{ if gt (len $breakItem) 0 }}
            {{ with index $breakItem 0 }}
            <div class="col-12 col-lg-10">
              <div class="card h-100 bg-light schedule-break">
                <div class="card-body text-center d-flex align-items-center justify-content-center">
                  <h6 class="card-title mb-0 font-weight-bold">{{ .Title }}</h6>
                </div>
              </div>
            </div>
            {{ end }}
          {{ else }}
            {{ range $track := $displayTracks }}
              <div class="col-12 col-lg-{{ $colWidth }} mb-3 mb-lg-0">
                {{ $talksForSlot_All := where $dayTalks "Params.talk_room" $track }}
                {{ $talkForSlot := slice }}
                {{ range $talksForSlot_All }}{{ if eq (.Date.Format "15:04") $t }}{{ $talkForSlot = $talkForSlot | append . }}{{ end }}{{ end }}

                {{ with first 1 $talkForSlot }}
                  {{ $talk := index . 0 }}
                  <a class="d-block h-100" href="{{ $talk.RelPermalink }}">
                    <div class="card h-100 shadow-sm schedule-card">
                      <div class="card-body d-flex">
                        {{ with $talk.Params.speaker_image }}
                          <div class="mr-3 flex-shrink-0"><img src="{{ . }}" alt="{{ $talk.Params.speaker_name }}" class="rounded-circle" style="width:48px;height:48px;object-fit:cover;" loading="lazy"></div>
                        {{ end }}
                        <div>
                          <h6 class="card-title mb-1">{{ $talk.Title }}</h6>
                          <div class="text-muted small">{{ $talk.Params.speaker_name }}</div>
                        </div>
                      </div>
                    </div>
                  </a>
                {{ end }}
              </div>
            {{ end }}
          {{ end }}
        </div>
      {{ end }}
    {{ end }}
  </div>
</section>