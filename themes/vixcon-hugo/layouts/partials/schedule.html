{{/*
  SCHEDULE GRID
  - Supports `type: "talk"` for 3-column track items.
  - Supports `type: "break"` for full-width items like coffee breaks.
*/}}

{{ if eq .Page.Params.outdated true  }}
    <div class="ui warning message">
        <h2 class="header">Warning! - Outdated content</h2>
        <p>You are watching the speakers for a previous year!<br>
        Please find the most current schedule under: <a href="/schedule/{{ now.Year }}" style="font-weight: bold; text-decoration: underline;">Current schedule</a></p>
    </div>
{{ end }}


{{ $page := . }}
{{ $isDebug := false}}

{{/* 1. Collect all schedule items and filter */}}
{{ $allEvents := where site.RegularPages "Type" "in" (slice "talk" "break") }}
{{ $allEvents = where $allEvents "Draft" "ne" true }}

{{ $.Scratch.Set "yearInt" 0 }}
{{ with .Params.schedule_year }}
  {{ $.Scratch.Set "yearInt" (int (strings.TrimPrefix "year_" .)) }}
{{ end }}
{{ $yearInt := $.Scratch.Get "yearInt" }}

{{ if ne $yearInt 0 }}
  {{ $allEvents = where $allEvents "Date.Year" $yearInt }}
{{ end }}

{{/* 3. Dynamically discover and sort tracks from content */}}
{{ $talksForTracks := where $allEvents "Type" "talk" }}
{{ $trackNames := slice }}
{{ range $talksForTracks }}
  {{ with .Params.talk_room }}
    {{ $trackNames = $trackNames | append . }}
  {{ end }}
{{ end }}
{{ $discoveredTracks := $trackNames | uniq }}

{{ $trackOrders := dict
  "2024" (slice "Track 1" "Track 2")
  "2025" (slice "Software & Hardware (So-Ha)" "Data Centers / Infrastructure / Management (DIM)" "Community Track") 
}}
{{ $trackOrder := index $trackOrders (string $yearInt) }}

{{ $displayTracks := slice }}
{{ if $trackOrder }}
  {{ range $track := $trackOrder }}
    {{ if in $discoveredTracks $track }}
      {{ $displayTracks = $displayTracks | append $track }}
    {{ end }}
  {{ end }}
  {{/* Add any tracks not in the predefined order to the end, sorted alphabetically */}}
  {{ $sortedDiscovered := $discoveredTracks | sort }}
  {{ range $track := $sortedDiscovered }}
      {{ if not (in $displayTracks $track) }}
          {{ $displayTracks = $displayTracks | append $track }}
      {{ end }}
  {{ end }}
{{ else }}
  {{ $displayTracks = $discoveredTracks | sort }}
{{ end }}

{{ $days := sort ($allEvents.GroupByDate "2006-01-02") "Key" }}

<section id="section-schedule" class="section-schedule section">
  <div class="container">
    <div class="row section-heading">
      <div class="col-lg">
        <div class="heading">
          <span class="stroke-text">Schedule</span>
          <div class="pl-90">
            <h2 class="mt-2">{{ .Title }}</h2>
            <p>Our program. Click a talk for details.</p>
          </div>
        </div>
      </div>
    </div>

    {{ if $isDebug }}
    <div class="row justify-content-center my-4">
      <div class="col-md-6">
        <div class="input-group">
          <input type="text" id="debug-time-input" class="form-control" placeholder="YYYY-MM-DD HH:mm">
          <div class="input-group-append">
            <button class="btn btn-primary" type="button" id="debug-time-button">Update</button>
          </div>
        </div>
        <small class="form-text text-muted">Enter a date and time, then click Update to test the schedule highlighting.</small>
      </div>
    </div>
    {{ end }}

    {{ if gt (len $days) 1 }}
    <div class="row justify-content-center my-4">
        <button id="jump-to-current-talk" class="btn btn-secondary mx-">Jump to Current Talks</button>
    {{ range $day := $days }}
        <a href="#schedule-{{ $day.Key }}" class="btn btn-secondary mx-2">{{ (time $day.Key).Format "Monday, 02 Jan" }}</a>
    {{ end }}
    </div>
    {{ end }}

    {{/* 4. Group events by day */}}
    {{ range $day := $days }}
      {{ $dayEvents := $day.Pages }}
      {{ $dayTalks := where $dayEvents "Type" "talk" }}
      {{ $dayBreaks := where $dayEvents "Type" "break" }}

      {{ $times := slice }}
      {{ range $dayEvents }}{{ $times = $times | append (.Date.Format "15:04") }}{{ end }}
      {{ $times = $times | uniq | sort }}

      <div class="row mt-5" id="schedule-{{ $day.Key }}"><div class="col-12"><h3 class="mb-4">{{ (time $day.Key).Format "Monday, 02 January 2006" }}</h3></div></div>

      <div class="row align-items-end mb-4 d-none d-lg-flex">
        <div class="col-lg-1"><div class="text-uppercase small font-weight-bold text-muted">Time</div></div>
        {{ range $track := $displayTracks }}<div class="col-lg"><h4 class="text-uppercase small font-weight-bold">{{ . }}</h4></div>{{ end }}
      </div>

      {{/* 5. Render rows for each time slot */}}
      {{ range $i, $t := $times }}
        {{ $nextIndex := add $i 1 }}
        {{ $endTime := "" }}
        {{ if lt $nextIndex (len $times) }}
          {{ $endTime = index $times $nextIndex }}
        {{ end }}

        {{ $breakItem := slice }}
        {{ range $dayBreaks }}{{ if eq (.Date.Format "15:04") $t }}{{ $breakItem = $breakItem | append . }}{{ end }}{{ end }}

        <div class="row align-items-stretch mb-3 py-3 border-bottom schedule-row" data-date="{{ $day.Key }}" data-start-time="{{ $t }}" data-end-time="{{ $endTime }}">
          <div class="col-12 col-lg-1 mb-2 mb-lg-0"><h5 class="time text-color mb-0">{{ $t }}</h5></div>

          {{ if gt (len $breakItem) 0 }}
            {{ with index $breakItem 0 }}
            <div class="col-12 col-lg-11">
              <div class="card h-100 bg-light schedule-break">
                <div class="card-body text-center d-flex align-items-center justify-content-center">
                  <h6 class="card-title mb-0 font-weight-bold">
                      {{ if .Params.Break_link }}
                        <a href="{{ .Params.Break_link }}">➡️ <u>{{ .Title }}</u> </a>
                      {{ else }}
                        {{ .Title }}
                      {{ end}}
                  </h6>
                </div>
              </div>
            </div>
            {{ end }}
          {{ else }}
            {{ range $track := $displayTracks }}
              <div class="col-12 col-lg mb-3 mb-lg-0">
                {{ $talksForSlot_All := where $dayTalks "Params.talk_room" $track }}
                {{ $talkForSlot := slice }}
                {{ range $talksForSlot_All }}{{ if eq (.Date.Format "15:04") $t }}{{ $talkForSlot = $talkForSlot | append . }}{{ end }}{{ end }}

                {{ with first 1 $talkForSlot }}
                  {{ $talk := index . 0 }}
                  <a class="d-block h-100" href="{{ $talk.RelPermalink }}">
                    <div class="card h-100 shadow-sm schedule-card" style="position: relative;">
                      <div class="card-body d-flex">
                          <div class="mr-3 flex-shrink-0">
                        {{ if $talk.Params.speaker_image }}
                            <img src="/{{ $talk.Params.speaker_image }}" alt="{{ $talk.Params.speaker_name }}" class="rounded-circle speaker-image-schedule" loading="lazy">
                        {{ end }}
                        {{ if $talk.Params.speaker_2_image }}
                            <br>
                            <img src="/{{ $talk.Params.speaker_2_image }}" alt="{{ $talk.Params.speaker_2_name }}" class="rounded-circle speaker-image-schedule speaker-image-schedule-additional" loading="lazy">
                        {{ end }}
                        {{ if $talk.Params.speaker_3_image }}
                            <br>
                            <img src="/{{ $talk.Params.speaker_3_image }}" alt="{{ $talk.Params.speaker_3_name }}" class="rounded-circle speaker-image-schedule speaker-image-schedule-additional" loading="lazy">
                        {{ end }}
                          </div>
                        <div>
                          <h6 class="card-title mb-1">{{ $talk.Title }}</h6>
                          <div class="text-muted small">
                              <b>
                                  {{ $talk.Params.speaker_name }}
                                  {{ if $talk.Params.speaker_2_name }} | {{ $talk.Params.speaker_2_name }}{{ end }}
                                  {{ if $talk.Params.speaker_3_name }} | {{ $talk.Params.speaker_3_name }}{{ end }}
                              </b>
                              <br>
                              {{ $talk.Params.speaker_company }}
                              {{ if and $talk.Params.speaker_2_company (ne $talk.Params.speaker_company $talk.Params.speaker_2_company) }} | {{ $talk.Params.speaker_2_company }}{{ end }}
                              {{ if and $talk.Params.speaker_3_company (ne $talk.Params.speaker_company $talk.Params.speaker_3_company) (ne $talk.Params.speaker_2_company $talk.Params.speaker_3_company) }} | {{ $talk.Params.speaker_2_company }}{{ end }}
                          </div>
                        </div>
                      </div>
                      {{ with $talk.Params.talk_label }}
                        <span style="position: absolute; bottom: 0px; right: 0px; background-color: #3d936f; color: white; padding: 0.1px 5px; border-radius: 3px; font-size: 0.5rem;">{{ . }}</span>
                      {{ end }}
                    </div>
                  </a>
                {{ end }}
              </div>
            {{ end }}
          {{ end }}
        </div>
      {{ end }}
    {{ end }}
  </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const debugInput = document.getElementById('debug-time-input');
  const debugButton = document.getElementById('debug-time-button');

  function highlightSchedule() {
    // Clear previous highlights
    document.querySelectorAll('.schedule-row').forEach(row => {
      row.style.backgroundColor = '';
    });

    let now;
    if (debugInput && debugInput.value) {
      const dateTimeString = debugInput.value.replace(' ', 'T');
      now = new Date(dateTimeString);
    } else {
      now = new Date();
    }

    if (isNaN(now)) {
      return null;
    }

    let highlightedRow = null;
    const rows = document.querySelectorAll('.schedule-row');
    rows.forEach(row => {
      const date = row.dataset.date;
      const startTimeStr = row.dataset.startTime;
      const endTimeStr = row.dataset.endTime;

      if (date && startTimeStr && endTimeStr) {
        const startDateTime = new Date(`${date}T${startTimeStr}`);
        const endDateTime = new Date(`${date}T${endTimeStr}`);

        if (now >= startDateTime && now < endDateTime) {
          row.style.backgroundColor = '#f0fff0';
          highlightedRow = row;
        }
      }
    });
    return highlightedRow;
  }

  // Event listener for jump to current talk button
  const jumpButton = document.getElementById('jump-to-current-talk');
  if(jumpButton) {
    jumpButton.addEventListener('click', function() {
      const highlightedRow = highlightSchedule();
      if (highlightedRow) {
        highlightedRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    });
  }

  // Initial highlight and scroll
  const initialHighlightedRow = highlightSchedule();
  if (initialHighlightedRow && !(debugInput && debugInput.value)) {
    initialHighlightedRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }

  // Event listener for debug button
  if (debugButton) {
    debugButton.addEventListener('click', () => {
      const highlightedRow = highlightSchedule();
      if (highlightedRow) {
        highlightedRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    });
  }

  // Set interval to update highlight every 30 seconds (without scrolling)
  setInterval(highlightSchedule, 30000);
});
</script>
